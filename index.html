<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ì„œìš¸ ìì¹˜êµ¬ë³„ CCTV ì„¤ì¹˜ ëŒ€ë¹„ ë²”ì£„ ë°œìƒëŸ‰ ë¶„ì„ ì§€ë„</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.11.1/dist/geosearch.css"/>
    <script src="https://unpkg.com/leaflet-geosearch@3.11.1/dist/geosearch.umd.js"></script>
    <style>
        html, body { height: 100%; margin: 0; }
        #map { height: 100%; width: 100%; }
        .map-title {
            position: absolute; z-index: 1000; left: 12px; top: 12px;
            background: rgba(255,255,255,0.95);
            border-radius: 12px; padding: 10px 12px; box-shadow: 0 2px 10px rgba(0,0,0,.1);
            font-size: 16px; line-height: 1.2; color: #111; font-weight: 700;
        }
        #yearSelector {
            position: absolute; z-index: 1000; left: 12px; top: 60px;
            padding: 8px; border-radius: 8px; border: 1px solid #ccc;
            font-size: 14px;
        }
        /* ìƒ‰ìƒ ë²”ë¡€ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        #legend {
            position: absolute; z-index: 1000; left: 12px; top: 110px; 
            background: rgba(255,255,255,0.95);
            padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,.1);
            font-size: 12px; line-height: 1.5;
            min-width: 280px;
        }
        .legend-section { margin-top: 5px; padding-top: 5px; }
        .legend-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 3px; }
        .legend-color {
            width: 15px; height: 15px; border: 1px solid #333; margin-right: 6px;
        }

        /* ë§ˆì»¤ í¬ê¸° ë° ìŠ¤íƒ€ì¼ ì¡°ì • */
        .custom-marker div { 
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 8px rgba(0,0,0,0.6);
            font-size: 0; 
            transition: all 0.3s ease; 
        }
        /* ë§ˆì»¤ íˆ´íŒ ìŠ¤íƒ€ì¼: ìì¹˜êµ¬ ì´ë¦„ì´ í•­ìƒ í‘œì‹œë˜ë„ë¡ */
        .leaflet-tooltip {
            background-color: transparent !important;
            border: none !important;
            color: #111 !important;
            font-weight: 700; 
            font-size: 11px; 
            padding: 0;
            white-space: nowrap;
            text-shadow: 1px 1px 2px #fff; 
            opacity: 1 !important; 
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="mapTitle" class="map-title">ì„œìš¸ ìì¹˜êµ¬ë³„ CCTV ì„¤ì¹˜ ëŒ€ë¹„ ë²”ì£„ ë°œìƒëŸ‰ ë¶„ì„ (2024ë…„ ê¸°ì¤€)</div>
    
    <select id="yearSelector">
        <option value="2024">2024ë…„</option>
        <option value="2023">2023ë…„</option>
        <option value="2022">2022ë…„</option>
        <option value="2021">2021ë…„</option>
        <option value="2020">2020ë…„</option>
    </select>

    <div id="legend">
        </div>

    <script>
    // ğŸ“Œ 1. ìœµí•© ë°ì´í„° (CCTV ë° ë²”ì£„ ë°œìƒ í˜„í™©)
    const MERGED_DATA = {"ì¢…ë¡œêµ¬": [227, 85, 228, 981, 987, 3102, 2712, 3138, 2981, 2765, 37.59918, 126.98687], "ì¤‘êµ¬": [345, 404, 137, 138, 582, 3411, 2861, 3071, 3348, 2955, 37.56385, 126.99723], "ìš©ì‚°êµ¬": [622, 430, 458, 407, 654, 2969, 2381, 2967, 3021, 3322, 37.53239, 126.99037], "ì„±ë™êµ¬": [387, 294, 170, 316, 207, 2362, 2112, 2194, 2023, 2117, 37.551, 127.04257], "ê´‘ì§„êµ¬": [194, 739, 276, 348, 1015, 3601, 3087, 3619, 3424, 2870, 37.54823, 127.08575], "ë™ëŒ€ë¬¸êµ¬": [229, 226, 317, 753, 863, 3409, 2806, 3217, 3390, 3280, 37.57469, 127.03975], "ì¤‘ë‘êµ¬": [989, 604, 336, 684, 894, 3669, 3051, 3604, 3408, 3230, 37.60677, 127.09278], "ì„±ë¶êµ¬": [202, 374, 340, 408, 1064, 3144, 2690, 3280, 3226, 3244, 37.60677, 127.027], "ê°•ë¶êµ¬": [538, 393, 639, 373, 840, 2779, 2269, 2959, 2841, 2805, 37.63777, 127.02534], "ë„ë´‰êµ¬": [151, 544, 530, 636, 585, 2191, 1878, 2378, 2341, 2465, 37.66874, 127.04712], "ë…¸ì›êµ¬": [382, 213, 161, 623, 1352, 3354, 2788, 3405, 3405, 3360, 37.65383, 127.05607], "ì€í‰êµ¬": [451, 571, 502, 466, 874, 3381, 2867, 3465, 3302, 3177, 37.61918, 126.92723], "ì„œëŒ€ë¬¸êµ¬": [613, 425, 213, 422, 425, 3330, 2664, 3158, 3060, 3004, 37.57948, 126.93666], "ë§ˆí¬êµ¬": [239, 164, 70, 736, 473, 3139, 2724, 3505, 3370, 3099, 37.56619, 126.9015], "ì–‘ì²œêµ¬": [346, 355, 388, 993, 583, 3175, 2717, 3463, 3528, 3173, 37.52737, 126.8654], "ê°•ì„œêµ¬": [361, 435, 604, 429, 1056, 3486, 3034, 3960, 4122, 3959, 37.56158, 126.82282], "êµ¬ë¡œêµ¬": [752, 690, 337, 486, 1322, 4016, 3350, 4242, 4165, 4059, 37.4952, 126.88768], "ê¸ˆì²œêµ¬": [516, 207, 304, 824, 750, 2707, 2337, 2707, 2768, 2796, 37.45688, 126.90224], "ì˜ë“±í¬êµ¬": [1300, 288, 438, 438, 755, 4976, 3647, 4434, 4101, 3986, 37.52554, 126.91138], "ë™ì‘êµ¬": [430, 31, 359, 427, 769, 2981, 2453, 3046, 3072, 3096, 37.49603, 126.93922], "ê´€ì•…êµ¬": [401, 550, 138, 743, 1051, 4426, 3777, 4771, 4596, 4496, 37.47831, 126.95531], "ì„œì´ˆêµ¬": [419, 565, 878, 457, 641, 3719, 3371, 4118, 4153, 3940, 37.48364, 127.03254], "ê°•ë‚¨êµ¬": [677, 491, 585, 869, 588, 4991, 4268, 5171, 5064, 4768, 37.51737, 127.04738], "ì†¡íŒŒêµ¬": [263, 175, 373, 941, 747, 4005, 3334, 4390, 4488, 4118, 37.51457, 127.10664], "ê°•ë™êµ¬": [614, 262, 381, 359, 688, 3450, 2872, 3816, 3788, 3583, 37.55018, 127.14725]};
    
    // ğŸš¨ ë…„ë„ë³„ ë°ì´í„° ì¸ë±ìŠ¤ ë§¤í•‘ ë° ì‹œì‘ ì¸ë±ìŠ¤
    const YEAR_INDEX = { "2020": 0, "2021": 1, "2022": 2, "2023": 3, "2024": 4 };
    const CCTV_DATA_START_INDEX = 0; // CCTV ë°ì´í„°ëŠ” 0ë²ˆ ì¸ë±ìŠ¤ë¶€í„° ì‹œì‘ ([0]~[4])
    const CRIME_DATA_START_INDEX = 5; // ë²”ì£„ ë°ì´í„°ëŠ” 5ë²ˆ ì¸ë±ìŠ¤ë¶€í„° ì‹œì‘ ([5]~[9])
    
    // ğŸ“Œ 2. ë§µ ì´ˆê¸°í™”
    const map = L.map('map', { center: [37.5665, 126.9780], zoom: 11, scrollWheelZoom: true });
    
    // ğŸ’¡ ì§€ë„ íƒ€ì¼ ì„œë²„ (OpenStreetMap í‘œì¤€)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Map data Â© OpenStreetMap contributors'
    }).addTo(map);

    const markers = L.markerClusterGroup({ showCoverageOnHover: false, spiderfyOnMaxZoom: true });
    
    // ğŸ“Œ 3. ì‹œê°í™” ìŠ¤ì¼€ì¼ í•¨ìˆ˜

    // CCTV ì„¤ì¹˜ ëŒ€ë¹„ ë²”ì£„ ë°œìƒëŸ‰ (Rate)ì— ë”°ë¼ ìƒ‰ìƒ ê²°ì • (4ë‹¨ê³„)
    function getRateColor(rate_value) {
        if (rate_value > 800) return '#d73027'; // ì§„í•œ ë¹¨ê°• (800ê±´ ì´ˆê³¼)
        if (rate_value > 600) return '#fc8d59';  // ì£¼í™©
        if (rate_value > 400) return '#91bfdb';  // ì—°í•œ íŒŒë‘
        return '#4575b4';                          // ì§„í•œ íŒŒë‘ (400ê±´ ì´í•˜)
    }
    
    // CCTV ì„¤ì¹˜ ìˆ˜ (Count)ì— ë”°ë¼ ë§ˆì»¤ í¬ê¸° ê²°ì • (ë²”ìœ„ ê·¹ëŒ€í™”)
    const CCTV_COUNT_MIN = 200; 
    const CCTV_COUNT_MAX = 1400; 
    const SIZE_MIN = 10;    
    const SIZE_MAX = 150;   

    function getCCTVSize(cctv_count) {
        const normalized = Math.max(0, Math.min(1, (cctv_count - CCTV_COUNT_MIN) / (CCTV_COUNT_MAX - CCTV_COUNT_MIN)));
        const scaled = Math.sqrt(normalized); 
        return Math.round(SIZE_MIN + scaled * (SIZE_MAX - SIZE_MIN));
    }
    
    // ğŸ“Œ 4. ë§ˆì»¤ ì—…ë°ì´íŠ¸ ë° ì‹œê°í™” ì£¼ í•¨ìˆ˜ (ë…„ë„ë³„ ë°ì´í„° ì„ íƒ í¬í•¨)
    function updateMapData() {
        const selectedYear = document.getElementById('yearSelector').value;
        const cctvIndex = YEAR_INDEX[selectedYear] + CCTV_DATA_START_INDEX;
        const crimeIndex = YEAR_INDEX[selectedYear] + CRIME_DATA_START_INDEX;

        markers.clearLayers(); 

        Object.keys(MERGED_DATA).forEach(gu_name => {
            const dataRow = MERGED_DATA[gu_name];
            const cctvCount = dataRow[cctvIndex]; 
            const crimeCount = dataRow[crimeIndex];
            const lat = dataRow[10]; 
            const lng = dataRow[11]; 
            
            // 1. CCTV 100ëŒ€ë‹¹ ë²”ì£„ ë¹„ìœ¨ (ìƒ‰ìƒ) ê³„ì‚°
            const rateValue = (cctvCount > 0) ? Math.round((crimeCount / cctvCount) * 100) : 0;
            
            // 2. ì‹œê°í™” ê°’ ê²°ì • (ìµœì¢… ìš”ì²­ ë°˜ì˜: ìƒ‰ìƒ=í•„ìš”ì„±, í¬ê¸°=ì„¤ì¹˜ìˆ˜)
            const markerColor = getRateColor(rateValue);   // ìƒ‰ìƒ = CCTV ì„¤ì¹˜ ëŒ€ë¹„ ë²”ì£„ ë°œìƒëŸ‰
            const markerSize = getCCTVSize(cctvCount);     // í¬ê¸° = CCTV ì„¤ì¹˜ ìˆ˜

            // ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì ìš©
            const customIcon = L.divIcon({
                className: `custom-marker`,
                html: `<div style="background-color: ${markerColor}; width: ${markerSize}px; height: ${markerSize}px;"></div>`, 
                iconSize: [markerSize, markerSize],
                iconAnchor: [markerSize / 2, markerSize / 2]
            });

            const popupHtml = `
                <div>
                    <b>${gu_name} (${selectedYear}ë…„)</b><br/>
                    <small>CCTV ì„¤ì¹˜ ìˆ˜ (í¬ê¸°): ${cctvCount.toLocaleString()}ëŒ€</small><br/>
                    <small>ì‹¤ì œ ë²”ì£„ ë°œìƒëŸ‰: ${crimeCount.toLocaleString()}ê±´</small><br/>
                    <hr style="margin: 4px 0;">
                    <b>CCTV ì„¤ì¹˜ ëŒ€ë¹„ ë²”ì£„ ë°œìƒëŸ‰ (ìƒ‰ìƒ): ${rateValue.toLocaleString()}ê±´</b>
                </div>`;
            
            const m = L.marker([lat, lng], { icon: customIcon });
            m.bindPopup(popupHtml);
            
            // ğŸ“Œ ìì¹˜êµ¬ ì´ë¦„ì„ ë§ˆì»¤ ê·¼ì²˜ì— ì˜êµ¬ì ìœ¼ë¡œ í‘œì‹œ
            m.bindTooltip(gu_name, { permanent: true, direction: 'right', className: 'leaflet-tooltip' });

            markers.addLayer(m);
        });
        
        map.addLayer(markers);

        // ì œëª© ë° ë²”ë¡€ ì—…ë°ì´íŠ¸
        document.getElementById('mapTitle').innerText = `ì„œìš¸ ìì¹˜êµ¬ë³„ CCTV ì„¤ì¹˜ ëŒ€ë¹„ ë²”ì£„ ë°œìƒëŸ‰ ë¶„ì„ (${selectedYear}ë…„ ê¸°ì¤€)`;
        
        // ğŸ“Œ ë²”ë¡€ ë‚´ìš© ì—…ë°ì´íŠ¸
        const legendDiv = document.getElementById('legend');
        let html = `<b>ë¶„ì„ ë²”ë¡€ (${selectedYear}ë…„ ê¸°ì¤€)</b>`;
        
        // ìƒ‰ìƒ ê¸°ì¤€ (CCTV ì„¤ì¹˜ ëŒ€ë¹„ ë²”ì£„ ë°œìƒëŸ‰)
        html += `<div class="legend-section"><b>ìƒ‰ìƒ: CCTV ì„¤ì¹˜ ëŒ€ë¹„ ë²”ì£„ ë°œìƒëŸ‰ (CCTV 100ëŒ€ë‹¹ ê±´ìˆ˜)</b></div>`;
        html += `<div class="legend-item"><span><div class="legend-color" style="background-color: #d73027;"></div>800ê±´ ì´ˆê³¼ (ê°€ì¥ ë†’ìŒ)</span></div>`;
        html += `<div class="legend-item"><span><div class="legend-color" style="background-color: #fc8d59;"></div>601ê±´ ~ 800ê±´</span></div>`;
        html += `<div class="legend-item"><span><div class="legend-color" style="background-color: #91bfdb;"></div>401ê±´ ~ 600ê±´</span></div>`;
        html += `<div class="legend-item"><span><div class="legend-color" style="background-color: #4575b4;"></div>400ê±´ ì´í•˜ (ê°€ì¥ ë‚®ìŒ)</span></div>`;

        // í¬ê¸° ê¸°ì¤€ (CCTV ì„¤ì¹˜ ìˆ˜)
        html += `<div class="legend-section"><b>í¬ê¸°: CCTV ì„¤ì¹˜ ìˆ˜ (íˆ¬ì ê·œëª¨)</b></div>`;
        html += `<div class="legend-item"><span><div class="legend-color" style="background-color: #ccc; width:150px; height:150px; border-radius:50%; margin-left: 10px;"></div>${CCTV_COUNT_MAX}ëŒ€ ë‚´ì™¸ (ê°€ì¥ í° ê·œëª¨)</span></div>`;
        html += `<div class="legend-item"><span><div class="legend-color" style="background-color: #ccc; width:50px; height:50px; border-radius:50%; margin-left: 10px;"></div>ì•½ 700ëŒ€ ë‚´ì™¸</span></div>`;
        html += `<div class="legend-item"><span><div class="legend-color" style="background-color: #ccc; width:10px; height:10px; border-radius:50%; margin-left: 10px;"></div>${CCTV_COUNT_MIN}ëŒ€ ë‚´ì™¸ (ê°€ì¥ ì‘ì€ ê·œëª¨)</span></div>`;
        
        legendDiv.innerHTML = html;
    }
    
    // ğŸ“Œ 5. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ë° ì´ˆê¸° ë¡œë“œ
    
    // ë…„ë„ ì„ íƒ ë“œë¡­ë‹¤ìš´ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
    document.getElementById('yearSelector').addEventListener('change', updateMapData);

    // ì´ˆê¸° ë¡œë“œ
    updateMapData();

    // ğŸ“Œ 6. GeoSearch ê²€ìƒ‰ ì»¨íŠ¸ë¡¤ ì¶”ê°€
    const provider = new GeoSearch.OpenStreetMapProvider();
    const searchControl = new GeoSearch.GeoSearchControl({
        provider: provider, style: 'bar', showMarker: true, showPopup: false, autoClose: true,
        retainZoomLevel: false, animateZoom: true, searchLabel: 'ì£¼ì†Œ ë˜ëŠ” ì¥ì†Œ ê²€ìƒ‰', notFoundMessage: 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.',
    });
    map.addControl(searchControl);
    </script>
</body>
</html>